<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Portfolio & TradingView</title>

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js Data Labels Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <!-- TradingView Widget Script -->
  <script src="https://s3.tradingview.com/tv.js"></script>
  
  <style>
    /* ========= Loading Spinner ========= */
    .loader {
      border-top-color: #3490dc;
      animation: spinner 1s linear infinite;
    }
    @keyframes spinner {
      to { transform: rotate(360deg); }
    }
    /* ========= zoom-out effect บนมือถือ ========= */
    @media (max-width: 639px) {
      .zoom-out {
        transform: scale(0.8);
        transform-origin: top left;
        width: 125%;
        margin-bottom: -130px;
      }
      .zoom-out table {
        width: 100%;
      }
    }
    /* ========= สไตล์สำหรับ TradingView ========= */
    #chart {
      width: 100%;
      height: 100%;
    }
    .blue-text {
      color: #1E90FF;
    }
    @media (min-width: 1024px) {
      #coinSlider {
        margin-top:20px;
      }
      /* ซ่อน scrollbar บน Chrome, Safari, Opera */
      #coinSlider::-webkit-scrollbar {
        display: none;
      }
      /* ซ่อน scrollbar บน Firefox */
      #coinSlider {
        scrollbar-width: none;
      }
      /* สำหรับ IE และ Edge */
      #coinSlider {
        -ms-overflow-style: none;
      }
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-900 m-0">
  <!-- ================== LOGIN MODAL ================== -->
  <div id="loginModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
    <div class="bg-white rounded shadow p-6 w-80 md:w-96">
      <h2 class="text-xl font-bold mb-4 text-center">Login</h2>
      <form id="loginForm" class="space-y-4">
        <!-- ปุ่ม Login with Google -->
        <a href="/auth/google" class="w-full px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 block text-center mt-4">
          Login with Google
        </a>
      </form>
    </div>
  </div>
  <!-- ================== /LOGIN MODAL ================== -->

  <!-- ================== HEADER (Sticky Tabs) ================== -->
  <header class="fixed top-0 left-0 right-0 z-50 bg-white shadow">
    <div class="flex justify-center py-2">
      <button id="btnPortfolio" class="mx-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Portfolio</button>
      <button id="btnTradingView" class="mx-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">TradingView</button>
    </div>
  </header>

  <!-- ================== CONTENT: Portfolio ================== -->
  <main id="appContainer" class="max-w-5xl mx-auto p-4 mt-[4rem] hidden">
    <!-- Header ของ Portfolio -->
    <div class="flex flex-col sm:flex-row items-center justify-between mb-6">
      <h1 class="text-3xl font-bold mb-2 sm:mb-0">Portfolio Summary</h1>
      <div class="flex items-center space-x-4">
        <span class="font-medium">Main Currency: THB</span>
        <a href="/logout" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Logout</a>
      </div>
    </div>
    
    <!-- Controls: Sort & Export/Import -->
    <div class="flex flex-col sm:flex-row justify-between gap-4 mb-4">
      <div>
        <select id="sortSelect" class="px-3 py-2 border rounded">
          <option value="default">Sort By...</option>
          <option value="name">Name</option>
          <option value="amount">Amount</option>
          <option value="currency">Currency</option>
        </select>
      </div>
      <div class="flex gap-2">
        <button id="exportBtn" class="px-3 py-2 bg-teal-500 text-white rounded hover:bg-teal-600">Export CSV</button>
        <label for="importInput" class="px-3 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 cursor-pointer">Import CSV</label>
        <input type="file" id="importInput" accept=".csv" class="hidden">
      </div>
    </div>

    <!-- Form สำหรับเพิ่มบัญชี (เพิ่ม input สำหรับ Group) -->
    <form id="accountForm" class="mb-6">
      <div class="flex flex-col sm:flex-row gap-4">
        <input type="text" id="accountName" placeholder="Account name" required class="flex-1 px-4 py-2 border rounded">
        <input type="number" id="accountAmount" step="0.01" placeholder="Amount" required class="w-32 px-4 py-2 border rounded">
        <select id="accountCurrency" required class="w-28 px-4 py-2 border rounded">
          <option value="THB">THB</option>
          <option value="USD">USD</option>
        </select>
        <input type="text" id="accountGroup" placeholder="Group (optional)" class="w-48 px-4 py-2 border rounded">
        <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">Add Account</button>
      </div>
    </form>

    <!-- ปุ่มสำหรับ Save/Load -->
    <div class="flex flex-col sm:flex-row gap-4 mb-6">
      <button id="saveBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Save Data</button>
      <button id="loadBtn" class="px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600">Load Data</button>
    </div>

    <!-- ตารางแสดงบัญชี -->
    <div class="overflow-x-auto zoom-out">
      <table class="w-full min-w-full bg-white border border-gray-200">
        <thead>
          <tr class="bg-gray-100">
            <th class="py-2 px-4 border-b text-left">Account</th>
            <th class="py-2 px-4 border-b text-left">Amount (in THB)</th>
            <th class="py-2 px-4 border-b text-left">Original Currency</th>
            <th class="py-2 px-4 border-b text-left">Actions</th>
          </tr>
        </thead>
        <tbody id="accountsList">
          <!-- รายการบัญชีจะถูก render ผ่าน JavaScript -->
        </tbody>
      </table>
    </div>

    <!-- Filter Controls สำหรับ Coin Slider -->
    <div id="coinFilterControls" class="flex gap-4 items-center px-4 mt-4">
      <button id="showAllBtn" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 focus:outline-none">Show All</button>
      <button id="showFavBtn" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 focus:outline-none">Show Favorites</button>
    </div>

    <!-- Coin Slider -->
    <div id="coinSlider" class="flex gap-6 overflow-x-auto px-4 snap-x snap-mandatory"></div>

    <!-- Card สำหรับแสดง Latest FNG (Main Card) -->
    <div id="fngCard" class="max-w-sm mx-auto bg-white shadow-lg rounded-lg overflow-hidden mt-4">
      <div class="p-4">
        <h2 class="text-xl font-bold text-center mb-4">CMC Crypto Fear and Greed Index</h2>
        <div class="flex justify-center">
          <div class="relative w-36 h-36">
            <svg class="w-full h-full" viewBox="0 0 100 100">
              <circle class="text-gray-300" stroke-width="8" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50"></circle>
              <circle id="fngProgress" class="text-green-500" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50"
                stroke-dasharray="251.2" stroke-dashoffset="251.2"></circle>
            </svg>
            <div class="absolute inset-0 flex flex-col items-center justify-center">
              <span id="fngValue" class="text-2xl font-bold">--</span>
              <span id="fngClass" class="text-lg">--</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Card สำหรับ Historical Values -->
    <div id="historicalCard" class="max-w-sm mx-auto bg-white shadow-lg rounded-lg overflow-hidden mt-4">
      <div class="p-4">
        <h2 class="text-xl font-bold text-center mb-4">Historical Values</h2>
        <div class="space-y-2">
          <div class="flex justify-between">
            <span class="font-medium">Yesterday</span>
            <span id="historicalYesterday" class="font-medium">--</span>
          </div>
          <div class="flex justify-between">
            <span class="font-medium">Last Week</span>
            <span id="historicalLastWeek" class="font-medium">--</span>
          </div>
          <div class="flex justify-between">
            <span class="font-medium">Last Month</span>
            <span id="historicalLastMonth" class="font-medium">--</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Card สำหรับ Yearly High and Low -->
    <div id="yearlyCard" class="max-w-sm mx-auto bg-white shadow-lg rounded-lg overflow-hidden mt-4">
      <div class="p-4">
        <h2 class="text-xl font-bold text-center mb-4">Yearly High and Low</h2>
        <div class="space-y-2">
          <div class="flex justify-between">
            <span class="font-medium">Yearly High</span>
            <span id="yearlyHigh" class="font-medium">--</span>
          </div>
          <div class="flex justify-between">
            <span class="font-medium">Yearly Low</span>
            <span id="yearlyLow" class="font-medium">--</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ส่วนแสดงยอดรวม, Exchange Rate & FNG Cards -->
    <div class="bg-gray-100 p-4 rounded mt-6">
      <h3 class="text-xl font-semibold mb-2">Total Value:</h3>
      <p class="font-medium">
        THB: <span id="totalMain">0.00</span><br>
        USD: <span id="totalUSD">0.00</span>
      </p>
      <p id="exchangeRateDisplay" class="text-sm text-gray-700 mt-1"></p>
    </div>

    <!-- Chart Type Selector -->
    <div class="mt-6 mb-2">
      <label for="chartTypeSelect" class="font-medium mr-2">Select Chart Type:</label>
      <select id="chartTypeSelect" class="px-3 py-2 border rounded">
        <option value="line" selected>Line Chart</option>
        <option value="bar">Bar Chart</option>
        
        
      </select>
    </div>

    <!-- Chart Section -->
    <div class="mt-6 h-72">
      <h3 class="text-xl font-semibold mb-2">Account Distribution</h3>
      <canvas id="accountsChart" class="bg-white p-4 rounded shadow"></canvas>
    </div>

    <!-- Activity Log -->
    <br>
    <div class="mt-6">
      <h3 class="text-xl font-semibold mb-2">Activity Log</h3>
      <ul id="activityLog" class="list-disc pl-5 text-sm text-gray-700 max-h-48 overflow-y-auto border p-3 rounded bg-white"></ul>
    </div>
  </main>
  <!-- ================== /CONTENT Portfolio ================== -->

  <!-- ================== TRADINGVIEW OVERLAY ================== -->
  <div id="tradingviewOverlay" class="fixed left-0 right-0 bottom-0 top-[4rem] z-40 bg-white hidden">
    <div class="w-full h-full">
      <div id="chart"></div>
      <div class="text-center py-2">
        <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank">
          <span class="blue-text">Track all markets on TradingView</span>
        </a>
      </div>
    </div>
  </div>
  <!-- ================== /TRADINGVIEW OVERLAY ================== -->
   
  <!-- Confirmation Modal สำหรับลบ -->
  <div id="confirmModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
    <div class="bg-white rounded shadow p-6 w-80">
      <h2 class="text-xl font-bold mb-4">Confirm Delete</h2>
      <p class="mb-4">Are you sure you want to delete this account?</p>
      <div class="flex justify-end gap-2">
        <button id="cancelBtn" class="px-3 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
        <button id="confirmBtn" class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600">Delete</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="fixed bottom-4 right-4 flex flex-col gap-2 z-50"></div>

  <!-- Loading Indicator -->
  <div id="loadingOverlay" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 z-50 hidden">
    <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-16 w-16"></div>
  </div>

  <!-- ================== SCRIPT (Portfolio + ฟังก์ชัน) ================== -->
  <script>
    /*************** CONFIG & GLOBAL VARIABLES ***************/
    const devmode = false;
    let accounts = [];
    let editingId = null;
    const mainCurrency = "THB";
    let exchangeRates = {};
    let accountToDelete = null;
    let loggedIn = false;
    let chart;
    let currentChartType = "line";
    let isLoadingData = false; // flag สำหรับป้องกันการเรียกซ้ำ

    /*************** GLOBAL VARIABLES FOR FAVORITES ***************/
    let favorites = JSON.parse(localStorage.getItem('favoriteCoins')) || [];
    let coinFilterMode = localStorage.getItem('coinFilterMode') || 'all';
    const filledStarIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.97a1 1 0 00.95.69h4.178c.969 0 1.371 1.24.588 1.81l-3.38 2.455a1 1 0 00-.364 1.118l1.286 3.97c.3.921-.755 1.688-1.54 1.118l-3.38-2.455a1 1 0 00-1.175 0l-3.38 2.455c-.784.57-1.838-.197-1.539-1.118l1.286-3.97a1 1 0 00-.364-1.118L2.049 9.397c-.783-.57-.38-1.81.588-1.81h4.178a1 1 0 00.95-.69l1.286-3.97z"/></svg>`;
    const outlinedStarIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.97a1 1 0 00.95.69h4.178c.969 0 1.371 1.24.588 1.81l-3.38 2.455a1 1 0 00-.364 1.118l1.286 3.97c.3.921-.755 1.688-1.54 1.118l-3.38-2.455a1 1 0 00-1.175 0l-3.38 2.455c-.784.57-1.838-.197-1.539-1.118l1.286-3.97a1 1 0 00-.364-1.118L2.049 9.397c-.783-.57-.38-1.81.588-1.81h4.178a1 1 0 00.95-.69l1.286-3.97z"/></svg>`;

    function toggleFavorite(symbol) {
      if (favorites.includes(symbol)) {
        favorites = favorites.filter(s => s !== symbol);
      } else {
        favorites.push(symbol);
      }
      localStorage.setItem('favoriteCoins', JSON.stringify(favorites));
      loadCoinSlider();
    }

    /*************** UTILITY FUNCTIONS ***************/
    function logActivity(message) {
      const logList = document.getElementById('activityLog');
      const li = document.createElement('li');
      const now = new Date().toLocaleTimeString();
      li.textContent = `[${now}] ${message}`;
      logList.prepend(li);
    }

    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `px-4 py-2 rounded shadow text-white opacity-90 transform transition duration-300 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => {
        toast.classList.add('opacity-0', 'translate-y-2');
        setTimeout(() => { toast.remove(); }, 300);
      }, 3000);
    }

    function showLoading(show = true) {
      document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
    }

    /*************** EXCHANGE RATE & LOCAL STORAGE ***************/
    async function fetchExchangeRates() {
      try {
        const response = await fetch("https://open.er-api.com/v6/latest/THB");
        const data = await response.json();
        if (data.result === "success") {
          exchangeRates = data.rates;
          let rateUSD = parseFloat(exchangeRates["USD"]);
          if (rateUSD && rateUSD !== 0) {
            document.getElementById('exchangeRateDisplay').textContent =
              `Exchange Rate (USD to THB): 1 USD = ${(1 / rateUSD).toFixed(2)} THB`;
          } else {
            document.getElementById('exchangeRateDisplay').textContent = "";
          }
        } else {
          console.error("Exchange rate API error:", data);
        }
      } catch (error) {
        console.error("Error fetching exchange rates:", error);
      }
    }

    async function fetchFNG() {
      try {
        const res = await fetch('/fng');
        if (res.ok) {
          const data = await res.json();
          if (data.latest && data.latest.data) {
            const latest = data.latest.data;
            document.getElementById('fngValue').textContent = latest.value;
            document.getElementById('fngClass').textContent = latest.value_classification;
            const circumference = 2 * Math.PI * 40;
            const offset = circumference * (1 - latest.value / 100);
            document.getElementById('fngProgress').style.strokeDashoffset = offset;
          }
          if (data.historical && data.historical.data && Array.isArray(data.historical.data)) {
            const historical = data.historical.data;
            const latestTimestamp = parseInt(historical[0].timestamp);
            const oneDay = 86400;
            const sevenDays = 7 * oneDay;
            const thirtyDays = 30 * oneDay;
            function findClosest(target) {
              return historical.reduce((prev, curr) => {
                return (Math.abs(parseInt(curr.timestamp) - target) < Math.abs(parseInt(prev.timestamp) - target)) ? curr : prev;
              });
            }
            const yesterdayRecord = findClosest(latestTimestamp - oneDay);
            const lastWeekRecord = findClosest(latestTimestamp - sevenDays);
            const lastMonthRecord = findClosest(latestTimestamp - thirtyDays);
            document.getElementById('historicalYesterday').textContent = yesterdayRecord.value + " (" + yesterdayRecord.value_classification + ")";
            document.getElementById('historicalLastWeek').textContent = lastWeekRecord.value + " (" + lastWeekRecord.value_classification + ")";
            document.getElementById('historicalLastMonth').textContent = lastMonthRecord.value + " (" + lastMonthRecord.value_classification + ")";
            const yearlyHigh = historical.reduce((max, curr) => (curr.value > max.value ? curr : max), historical[0]);
            const yearlyLow = historical.reduce((min, curr) => (curr.value < min.value ? curr : min), historical[0]);
            function formatDate(timestamp) {
              const date = new Date(parseInt(timestamp) * 1000);
              const options = { month: 'short', day: '2-digit', year: 'numeric' };
              return date.toLocaleDateString(undefined, options);
            }
            document.getElementById('yearlyHigh').textContent = yearlyHigh.value + " (" + yearlyHigh.value_classification + ") on " + formatDate(yearlyHigh.timestamp);
            document.getElementById('yearlyLow').textContent = yearlyLow.value + " (" + yearlyLow.value_classification + ") on " + formatDate(yearlyLow.timestamp);
          }
        } else {
          console.error("Error fetching FNG data");
        }
      } catch (error) {
        console.error("Error fetching FNG data:", error);
      }
    }

    function saveAccountsLocal() {
      localStorage.setItem('accounts', JSON.stringify(accounts));
    }
    function loadAccountsLocal() {
      const stored = localStorage.getItem('accounts');
      if (stored) { accounts = JSON.parse(stored); }
    }

    function convertToMain(amount, currency) {
      if (currency === mainCurrency) return parseFloat(amount);
      if (currency === "USD") {
        let rate = parseFloat(exchangeRates["USD"]);
        if (!rate || rate === 0) return 0;
        return parseFloat(amount) / rate;
      }
      return 0;
    }

    function updateTotals() {
      let totalTHB = 0;
      accounts.forEach(acc => {
        totalTHB += convertToMain(acc.amount, acc.currency);
      });
      document.getElementById('totalMain').textContent =
        totalTHB.toLocaleString(undefined, { style: 'currency', currency: mainCurrency });
      let totalUSD = 0;
      const rateUSD = parseFloat(exchangeRates["USD"]);
      if (rateUSD && rateUSD !== 0) {
        totalUSD = totalTHB * rateUSD;
      }
      document.getElementById('totalUSD').textContent =
        totalUSD.toLocaleString(undefined, { style: 'currency', currency: 'USD' });
    }

    // Render accounts into the table
    function renderAccounts() {
      let list = accounts.slice();
      const sortType = document.getElementById('sortSelect').value;
      if (sortType === 'name') {
        list.sort((a, b) => a.name.localeCompare(b.name));
      } else if (sortType === 'amount') {
        list.sort((a, b) => parseFloat(b.amount) - parseFloat(a.amount));
      } else if (sortType === 'currency') {
        list.sort((a, b) => a.currency.localeCompare(b.currency));
      }
      
      const groups = {};
      list.forEach(account => {
        const grp = account.group && account.group.trim() !== "" ? account.group : "Ungrouped";
        if (!groups[grp]) groups[grp] = [];
        groups[grp].push(account);
      });
      
      const tbody = document.getElementById('accountsList');
      let html = "";
      for (const groupName in groups) {
        html += `<tr class="bg-gray-200"><td colspan="4" class="py-2 px-4 font-bold">${groupName}</td></tr>`;
        groups[groupName].forEach(account => {
          let convertedText = "";
          if (account.currency !== mainCurrency && exchangeRates[account.currency]) {
            const converted = convertToMain(account.amount, account.currency);
            convertedText = `<br/><span class="text-sm text-gray-600">≈ ${converted.toLocaleString(undefined, { style: 'currency', currency: mainCurrency })}</span>`;
          }
          html += `
            <tr>
              <td class="py-2 px-4 border-b">${account.name}</td>
              <td class="py-2 px-4 border-b">
                ${parseFloat(account.amount).toLocaleString()} ${account.currency}
                ${convertedText}
              </td>
              <td class="py-2 px-4 border-b">${account.currency}</td>
              <td class="py-2 px-4 border-b">
                <button type="button" onclick="editAccount('${account.id}')" class="px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">Edit</button>
                <button type="button" onclick="confirmDelete('${account.id}')" class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 ml-2">Delete</button>
              </td>
            </tr>
          `;
        });
      }
      tbody.innerHTML = html;
      updateChart();
    }

    function getNumericValue(parsed) {
      if (typeof parsed === 'object' && parsed !== null) {
        return parsed.y !== undefined ? parsed.y : parsed.x || 0;
      }
      return typeof parsed === 'number' ? parsed : 0;
    }

    function shadeColor(color, percent) {
      let R = parseInt(color.substring(1, 3), 16);
      let G = parseInt(color.substring(3, 5), 16);
      let B = parseInt(color.substring(5, 7), 16);
      R = parseInt((R * (100 + percent)) / 100);
      G = parseInt((G * (100 + percent)) / 100);
      B = parseInt((B * (100 + percent)) / 100);
      R = R < 255 ? R : 255;
      G = G < 255 ? G : 255;
      B = B < 255 ? B : 255;
      const RR = R.toString(16).padStart(2, "0");
      const GG = G.toString(16).padStart(2, "0");
      const BB = B.toString(16).padStart(2, "0");
      return "#" + RR + GG + BB;
    }

    function updateChart() {
      const nameTotals = {};
      accounts.forEach((acc) => {
        const amtTHB = convertToMain(acc.amount, acc.currency);
        if (!nameTotals[acc.name]) nameTotals[acc.name] = 0;
        nameTotals[acc.name] += amtTHB;
      });
      const sortedEntries = Object.entries(nameTotals).sort((a, b) => b[1] - a[1]);
      const labels = sortedEntries.map(e => e[0]);
      const data = sortedEntries.map(e => e[1]);
      const palette = [
        "#FF6384",
        "#36A2EB",
        "#FFCE56",
        "#4BC0C0",
        "#9966FF",
        "#FF9F40",
        "#66BB6A",
        "#42A5F5"
      ];
      let datasetConfig = {
        label: "Distribution (in THB)",
        data: data,
        backgroundColor: palette.slice(0, labels.length),
        borderColor: palette.slice(0, labels.length).map(color => shadeColor(color, -20)),
        borderWidth: 2,
        tension: 0.3,
        pointBackgroundColor: palette.slice(0, labels.length),
        pointBorderColor: "#fff",
        pointRadius: 5,
        fill: true,
        backgroundColor: palette[0] + "33"
      };
      const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: 20 },
        plugins: {
          legend: { display: true, position: "top", labels: { font: { size: 14, family: "Arial, sans-serif" } } },
          tooltip: {
            callbacks: {
              label: function (context) {
                const rawValue = getNumericValue(context.parsed);
                const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                const percent = ((rawValue / total) * 100).toFixed(2) + "%";
                return `${context.label}: ${rawValue.toLocaleString()} THB (${percent})`;
              }
            }
          },
          datalabels: {
            display: context => {
              const value = context.dataset.data[context.dataIndex] || 0;
              return value > 0;
            },
            formatter: (value, context) => {
              const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
              const percent = (value / total) * 100;
              return percent.toFixed(2) + "%";
            },
            color: "#fff",
            backgroundColor: "rgba(0, 0, 0, 0.7)",
            borderRadius: 4,
            padding: 4,
            anchor: "center",
            align: "center",
            offset: 10
          }
        },
        scales: {
          x: { grid: { display: false }, ticks: { font: { size: 12 } } },
          y: { grid: { color: "#f0f0f0" }, ticks: { beginAtZero: true, font: { size: 12 } } }
        }
      };
      if (chart) {
        chart.config.type = currentChartType;
        chart.data.labels = labels;
        chart.data.datasets[0] = datasetConfig;
        chart.options = commonOptions;
        chart.update();
      } else {
        const ctx = document.getElementById("accountsChart").getContext("2d");
        chart = new Chart(ctx, {
          type: currentChartType,
          data: { labels: labels, datasets: [datasetConfig] },
          plugins: [ChartDataLabels],
          options: commonOptions
        });
      }
    }

    function setupChartTypeSelector() {
      const chartTypeSelect = document.getElementById('chartTypeSelect');
      if (chartTypeSelect) {
        chartTypeSelect.addEventListener('change', (e) => {
          currentChartType = e.target.value;
          updateChart();
        });
      }
    }

    /*************** AUTO LOAD & AUTO SAVE FUNCTIONS ***************/
    async function autoSaveDataToServer() {
      if (!devmode && !loggedIn) return;
      showLoading(true);
      try {
        const res = await fetch('/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accounts })
        });
        if (res.ok) {
          logActivity('Data saved to server');
          showToast('Data auto-saved to server!', 'success');
        } else {
          showToast('Error auto-saving data.', 'error');
        }
      } catch (error) {
        console.error('Auto-save error:', error);
        showToast('Error auto-saving data.', 'error');
      }
      showLoading(false);
    }

    async function autoLoadDataFromServer() {
      if (!devmode && !loggedIn) return;
      if (isLoadingData) return;
      isLoadingData = true;
      showLoading(true);
      let success = false;
      while (!success) {
        try {
          const res = await fetch('/load');
          if (!res.ok) {
            throw new Error("Server load failed with status " + res.status);
          }
          const data = await res.json();
          accounts = data.accounts || [];
          saveAccountsLocal();
          await fetchExchangeRates();
          renderAccounts();
          updateTotals();
          logActivity('Data auto-loaded from server');
          showToast('Data loaded successfully from server!', 'success');
          success = true;
        } catch (error) {
          console.error('Auto-load error, retrying in 2 seconds:', error);
          showToast('Error loading data, retrying...', 'error');
          await new Promise(resolve => setTimeout(resolve, 2000));
        }
      }
      showLoading(false);
      isLoadingData = false;
    }

    /*************** COIN SLIDER: โหลดข้อมูลจาก CoinMarketCap API ***************/
    async function loadCoinSlider() {
      try {
        const res = await fetch('/cmc/listings');
        if (!res.ok) {
          throw new Error('Failed to fetch coin listings');
        }
        const data = await res.json();
        let coins = data.data;
        // ถ้า filter mode เป็น 'favorites' ให้กรองเฉพาะเหรียญที่อยู่ใน favorites
        if (coinFilterMode === 'favorites') {
          coins = coins.filter(coin => favorites.includes(coin.symbol));
        }
        let html = "";
        coins.forEach(coin => {
          const price = coin.quote.USD.price;
          const percentChange = coin.quote.USD.percent_change_24h;
          const arrowSvgDown = `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="inline-block" style="height: 16px; width: 16px;" viewBox="0 0 24 24"><path d="M18.0566 8H5.94336C5.10459 8 4.68455 9.02183 5.27763 9.61943L11.3343 15.7222C11.7019 16.0926 12.2981 16.0926 12.6657 15.7222L18.7223 9.61943C19.3155 9.02183 18.8954 8 18.0566 8Z"></path></svg>`;
          const arrowSvgUp = `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="inline-block" style="height: 16px; width: 16px;" viewBox="0 0 24 24"><path d="M5.94336 16H18.0566C18.8954 16 19.3155 14.9782 18.7223 14.3806L12.6657 8.27783C12.2981 7.90739 11.7019 7.90739 11.3343 8.27783L5.27763 14.3806C4.68455 14.9782 5.10459 16 5.94336 16Z"></path></svg>`;
          const changeIcon = percentChange < 0 ? arrowSvgDown : arrowSvgUp;
          const changeColor = percentChange < 0 ? 'red' : 'green';
          const priceFormatted = `$${price.toFixed(2)}`;
          const percentFormatted = `${Math.abs(percentChange).toFixed(2)}%`;
          
          // ตรวจสอบว่าเหรียญนี้เป็น favorite หรือไม่
          const isFav = favorites.includes(coin.symbol);
          const starIcon = isFav ? filledStarIcon : outlinedStarIcon;
          
          html += `
          <div class="w-48 bg-white rounded-xl shadow-lg p-4 relative flex-shrink-0 transform transition duration-300 hover:scale-105 snap-start">
            <button class="absolute top-2 right-2 focus:outline-none" onclick="toggleFavorite('${coin.symbol}')">
              ${starIcon}
            </button>
            <a target="_blank" href="/currencies/${coin.slug}/" class="block">
              <img class="w-16 h-16 mx-auto mb-2 rounded-full border border-gray-200" src="https://s2.coinmarketcap.com/static/img/coins/64x64/${coin.id}.png" alt="${coin.name} Logo" loading="lazy">
              <div class="text-center">
                <span class="block font-bold text-lg text-gray-800">${coin.name}</span>
                <span class="block text-sm text-gray-500">${coin.symbol}</span>
                <span class="block text-sm text-gray-500">${priceFormatted}</span>
                <span class="block text-sm font-medium" style="color: ${changeColor};">
                  ${changeIcon} ${percentFormatted}
                </span>
              </div>
              <img class="w-full mt-3" src="https://s3.coinmarketcap.com/generated/sparklines/web/1d/2781/${coin.id}.svg" alt="${coin.name} Price Graph">
            </a>
          </div>
          `;
        });
        document.getElementById('coinSlider').innerHTML = html;
      } catch (error) {
        console.error("Error loading coin slider:", error);
      }
    }

    /*************** FORM SUBMIT (Add/Edit Account) ***************/
    document.addEventListener('DOMContentLoaded', () => {
      setupChartTypeSelector();
      if (!devmode) {
        const adminLoginFields = document.getElementById('adminLoginFields');
        if (adminLoginFields) { adminLoginFields.classList.add('hidden'); }
      }
      // ตั้งค่า event listener สำหรับ filter control buttons
      document.getElementById('showAllBtn').addEventListener('click', () => {
        coinFilterMode = 'all';
        localStorage.setItem('coinFilterMode', coinFilterMode);
        loadCoinSlider();
      });
      document.getElementById('showFavBtn').addEventListener('click', () => {
        coinFilterMode = 'favorites';
        localStorage.setItem('coinFilterMode', coinFilterMode);
        loadCoinSlider();
      });
      
      document.getElementById('accountForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const account = {
          id: editingId || Date.now().toString(),
          name: document.getElementById('accountName').value,
          amount: document.getElementById('accountAmount').value,
          currency: document.getElementById('accountCurrency').value,
          group: document.getElementById('accountGroup').value.trim() || "Ungrouped"
        };
        if (editingId) {
          const idx = accounts.findIndex(a => a.id === editingId);
          accounts[idx] = account;
          logActivity(`Updated account: ${account.name}`);
          showToast('Account updated successfully!', 'success');
          editingId = null;
        } else {
          accounts.push(account);
          logActivity(`Added new account: ${account.name}`);
          showToast('Account added successfully!', 'success');
        }
        document.getElementById('accountForm').reset();
        saveAccountsLocal();
        renderAccounts();
        updateTotals();
        await autoSaveDataToServer();
      });
    });

    function editAccount(id) {
      const acc = accounts.find(a => a.id === id);
      document.getElementById('accountName').value = acc.name;
      document.getElementById('accountAmount').value = acc.amount;
      document.getElementById('accountCurrency').value = acc.currency;
      document.getElementById('accountGroup').value = acc.group || "";
      editingId = id;
    }

    function confirmDelete(id) {
      accountToDelete = id;
      document.getElementById('confirmModal').classList.remove('hidden');
    }
    document.getElementById('cancelBtn').addEventListener('click', () => {
      accountToDelete = null;
      document.getElementById('confirmModal').classList.add('hidden');
    });
    document.getElementById('confirmBtn').addEventListener('click', async () => {
      if (accountToDelete) {
        accounts = accounts.filter(a => a.id !== accountToDelete);
        logActivity(`Deleted account with ID: ${accountToDelete}`);
        showToast('Account deleted successfully!', 'success');
        accountToDelete = null;
        saveAccountsLocal();
        renderAccounts();
        updateTotals();
        await autoSaveDataToServer();
      }
      document.getElementById('confirmModal').classList.add('hidden');
    });

    document.getElementById('saveBtn').addEventListener('click', async () => {
      showLoading(true);
      try {
        const res = await fetch('/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accounts })
        });
        if (res.ok) {
          logActivity('Data saved to server (manual)');
          showToast('Data saved successfully to file!', 'success');
        } else {
          showToast('Error saving data.', 'error');
        }
      } catch (error) {
        console.error('Save error:', error);
        showToast('Error saving data.', 'error');
      }
      showLoading(false);
    });

    document.getElementById('loadBtn').addEventListener('click', async () => {
      await autoLoadDataFromServer();
    });

    document.getElementById('exportBtn').addEventListener('click', () => {
      let csvContent = "data:text/csv;charset=utf-8,Name,Amount,Currency,Group\n";
      accounts.forEach(acc => {
        csvContent += `${acc.name},${acc.amount},${acc.currency},${acc.group || ""}\n`;
      });
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "accounts.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      logActivity('Exported data as CSV');
      showToast('Data exported as CSV!', 'success');
    });

    document.getElementById('importInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        const text = event.target.result;
        const lines = text.split('\n').slice(1);
        lines.forEach(line => {
          if (line.trim()) {
            const parts = line.split(',');
            const [name, amount, currency, group] = parts;
            const newAcc = {
              id: Date.now().toString() + Math.random().toString().slice(2),
              name: (name || '').trim(),
              amount: (amount || '').trim(),
              currency: (currency || '').trim(),
              group: (group || '').trim() || "Ungrouped"
            };
            if(newAcc.name) { 
              accounts.push(newAcc);
              logActivity(`Imported account: ${newAcc.name}`);
            }
          }
        });
        saveAccountsLocal();
        renderAccounts();
        updateTotals();
        showToast('Data imported successfully!', 'success');
      };
      reader.readAsText(file);
    });

    document.getElementById('sortSelect').addEventListener('change', renderAccounts);

    if (devmode) {
      document.getElementById('loginForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const user = document.getElementById('username').value;
        const pass = document.getElementById('password').value;
        if (user === 'admin' && pass === 'admin') {
          loggedIn = true;
          document.getElementById('loginModal').classList.add('hidden');
          document.getElementById('appContainer').classList.remove('hidden');
          logActivity('User logged in via admin form (dev mode)');
          showToast('Login successful!', 'success');
          fetchExchangeRates().then(() => {
            renderAccounts();
            updateTotals();
          });
        } else {
          showToast('Invalid credentials.', 'error');
        }
      });
    }

    async function checkLoginStatus() {
      try {
        const res = await fetch('/user');
        const data = await res.json();
        if (data.loggedIn) {
          loggedIn = true;
          document.getElementById('loginModal').classList.add('hidden');
          document.getElementById('appContainer').classList.remove('hidden');
          logActivity('User logged in via Google');
        }
      } catch (error) {
        console.error('Error checking login status:', error);
      }
    }

    const btnPortfolio = document.getElementById('btnPortfolio');
    const btnTradingView = document.getElementById('btnTradingView');
    const appContainer = document.getElementById('appContainer');
    const tradingviewOverlay = document.getElementById('tradingviewOverlay');

    btnPortfolio.addEventListener('click', () => {
      tradingviewOverlay.classList.add('hidden');
      appContainer.classList.remove('hidden');
    });
    btnTradingView.addEventListener('click', () => {
      appContainer.classList.add('hidden');
      tradingviewOverlay.classList.remove('hidden');
    });

    window.addEventListener('load', async () => {
      await checkLoginStatus();
      await fetchExchangeRates();
      await fetchFNG();
      loadAccountsLocal();
      renderAccounts();
      updateTotals();
      // โหลด coin slider หลังจากโหลดหน้า
      loadCoinSlider();
    });

    document.addEventListener('visibilitychange', async () => {
      if (!document.hidden) {
        await autoLoadDataFromServer();
      }
    });
    window.addEventListener('focus', async () => {
      await autoLoadDataFromServer();
    });
  </script>

  <!-- ================== SCRIPT สำหรับ TradingView Widget (จดจำ symbol/interval) ================== -->
  <script>
    const savedSymbol   = localStorage.getItem('tvSymbol')   || "BINANCE:DOGEUSDT";
    const savedInterval = localStorage.getItem('tvInterval') || "240";

    const tvWidget = new TradingView.widget({
      "autosize": true,
      "symbol": savedSymbol,
      "interval": savedInterval,
      "theme": "dark",
      "style": "1",
      "locale": "en",
      "toolbar_bg": "#f1f3f6",
      "hide_side_toolbar": true,
      "allow_symbol_change": true,
      "watchlist": [
          "BINANCE:SOLUSDT",
          "BINANCE:DOGEUSDT",
          "BINANCE:PEPEUSDT",
          "BINANCE:TRUMPUSDT",
          "BINANCE:BTCUSDT",
          "BINANCE:ETHUSDT",
          "NASDAQ:NVDA",
          "NYSE:TSM"
      ],
      "details": true,
      "hotlist": true,
      "calendar": true,
      "studies": ["STD;SMA"],
      "container_id": "chart",
      "show_popup_button": true,
      "popup_width": "1000",
      "popup_height": "650"
    });

    if (typeof tvWidget.onChartReady === "function") {
      tvWidget.onChartReady(() => {
        tvWidget.chart().onSymbolChanged().subscribe(null, (symbolData) => {
          localStorage.setItem('tvSymbol', symbolData.name);
        });
        tvWidget.chart().onIntervalChanged().subscribe(null, (newInterval) => {
          localStorage.setItem('tvInterval', newInterval);
        });
      });
    }
  </script>
</body>
</html>
