<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AssetFusion Hub</title>
  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js Data Labels Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <!-- TradingView Widget Script -->
  <script src="https://s3.tradingview.com/tv.js"></script>
  
  <style>
    /* ========= Loading Spinner ========= */
    .loader {
      border-top-color: #3490dc;
      animation: spinner 1s linear infinite;
    }
    @keyframes spinner {
      to { transform: rotate(360deg); }
    }
    /* ========= ปรับตารางให้ไม่ต้องเลื่อนซ้ายขวา (Mobile) ========= */
    @media (max-width: 639px) {
      .table-fixed.w-full.text-sm {
        font-size: 0.75rem;
      }
      .table-fixed.w-full.text-sm th,
      .table-fixed.w-full.text-sm td {
        padding: 0.5rem;
        white-space: normal;
        word-wrap: break-word;
      }
    }
    /* ========= zoom-out effect ========= */
    @media (max-width: 639px) {
      .zoom-out {
        transform: scale(0.8);
        transform-origin: top left;
        width: 100%;
        margin-bottom: 1.5rem;
      }
      .zoom-out table {
        width: 100%;
      }
      #coinFilterControls {
        margin-bottom: 30px;
      }
    }
    /* ========= สไตล์สำหรับ TradingView ========= */
    #chart {
      width: 100%;
      height: 100%;
    }
    .blue-text {
      color: #1E90FF;
    }
    @media (min-width: 1024px) {
      #coinSlider {
        margin-top:20px;
      }
      #coinSlider::-webkit-scrollbar {
        display: none;
      }
      #coinSlider {
        scrollbar-width: none;
      }
      #coinSlider {
        -ms-overflow-style: none;
      }
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-900 m-0">
  <!-- ================== LOGIN MODAL ================== -->
  <div id="loginModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
    <div class="bg-white rounded shadow p-6 w-80 md:w-96">
      <h2 class="text-xl font-bold mb-4 text-center">Login</h2>
      <form id="loginForm" class="space-y-4">
        <a href="/auth/google" class="w-full px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 block text-center mt-4">
          Login with Google
        </a>
      </form>
    </div>
  </div>
  <!-- ================== /LOGIN MODAL ================== -->

  <!-- ================== HEADER (Sticky Tabs) ================== -->
  <header class="fixed top-0 left-0 right-0 z-50 bg-white shadow">
    <div class="flex justify-center py-2">
      <button id="btnPortfolio" class="mx-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Portfolio</button>
      <button id="btnTradingView" class="mx-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">TradingView</button>
    </div>
  </header>

  <!-- ================== CONTENT: Portfolio ================== -->
  <main id="appContainer" class="max-w-5xl mx-auto p-4 mt-[4rem] hidden">
    <!-- Header ของ Portfolio -->
    <div class="flex flex-col sm:flex-row items-center justify-between mb-6">
      <h1 class="text-3xl font-bold mb-2 sm:mb-0">Portfolio Summary test</h1>
      <div class="flex items-center space-x-4">
        <span class="font-medium">Main Currency: THB</span>
        <a href="/logout" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Logout</a>
      </div>
    </div>
    
    <!-- Controls: Sort & Export/Import -->
    <div class="flex flex-col sm:flex-row justify-between gap-4 mb-4">
      <div>
        <select id="sortSelect" class="px-3 py-2 border rounded">
          <option value="default">Sort By...</option>
          <option value="name">Name</option>
          <option value="amount">Amount</option>
          <option value="currency">Currency</option>
        </select>
      </div>
      <div class="flex gap-2">
        <button id="exportBtn" class="px-3 py-2 bg-teal-500 text-white rounded hover:bg-teal-600">Export CSV</button>
        <label for="importInput" class="px-3 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 cursor-pointer">Import CSV</label>
        <input type="file" id="importInput" accept=".csv" class="hidden">
      </div>
    </div>

    <!-- Form สำหรับเพิ่มบัญชี -->
    <form id="accountForm" class="mb-6">
      <div class="flex flex-col sm:flex-row gap-4">
        <input type="text" id="accountName" placeholder="Account name" required class="flex-1 px-4 py-2 border rounded">
        <input type="number" id="accountAmount" step="0.01" placeholder="Amount" required class="w-32 px-4 py-2 border rounded">
        <!-- (NEW) เพิ่ม input สำหรับต้นทุน (Cost) -->
        <input type="number" id="accountCost" step="0.01" placeholder="Cost" class="w-32 px-4 py-2 border rounded">
        <select id="accountCurrency" required class="w-28 px-4 py-2 border rounded">
          <option value="THB">THB</option>
          <option value="USD">USD</option>
        </select>
        <!-- (NEW) Group Selector + Manual -->
        <div class="flex flex-col">
          <label for="accountGroupSelect" class="font-medium">Group</label>
          <select id="accountGroupSelect" class="w-48 px-4 py-2 border rounded mt-1">
            <!-- options auto-generated by JS -->
          </select>
          <input type="text" id="accountGroupManual" placeholder="Type new group..." class="w-48 px-4 py-2 border rounded mt-2 hidden" />
        </div>
        <!-- (NEW) Subgroup Selector + Manual -->
        <div class="flex flex-col">
          <label for="accountSubgroupSelect" class="font-medium">Sub-group</label>
          <select id="accountSubgroupSelect" class="w-48 px-4 py-2 border rounded mt-1">
            <!-- options auto-generated by JS -->
          </select>
          <input type="text" id="accountSubgroupManual" placeholder="Type new sub-group..." class="w-48 px-4 py-2 border rounded mt-2 hidden" />
        </div>
        <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">Add Account</button>
      </div>
    </form>

    <!-- ปุ่มสำหรับ Save/Load -->
    <div class="flex flex-col sm:flex-row gap-4 mb-6">
      <button id="saveBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Save Data</button>
      <button id="loadBtn" class="px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600">Load Data</button>
    </div>

    <!-- ตารางแสดงบัญชี -->
    <div class="overflow-hidden sm:overflow-x-auto mt-4 shadow border border-gray-200 rounded">
      <table class="table-fixed w-full text-sm text-left text-gray-700">
        <thead class="bg-gray-50 text-xs uppercase text-gray-700">
          <tr>
            <th scope="col" class="px-4 py-2">Account</th>
            <th scope="col" class="px-4 py-2">Amount (in THB)</th>
            <th scope="col" class="px-4 py-2">Original Currency</th>
            <th scope="col" class="px-4 py-2">Actions</th>
          </tr>
        </thead>
        <tbody id="accountsList">
          <!-- รายการบัญชี render โดย JS -->
        </tbody>
      </table>
    </div>

    <!-- ส่วนแสดงยอดรวม, Exchange Rate & FNG Cards -->
    <div class="bg-gray-100 p-4 rounded mt-6">
      <h3 class="text-xl font-semibold mb-4">Portfolio Value</h3>
      <div class="flex flex-col sm:flex-row gap-4">
        <!-- Card #1: All Groups -->
        <div class="flex-1 bg-white p-4 rounded shadow">
          <h4 class="text-lg font-semibold mb-2">All Groups</h4>
          <p class="text-gray-800">
            <span class="font-medium">THB (All):</span>
            <span id="totalMain" class="ml-1 font-semibold">0.00</span>
          </p>
          <p class="text-gray-800">
            <span class="font-medium">USD (All):</span>
            <span id="totalUSD" class="ml-1 font-semibold">0.00</span>
          </p>
          <p id="exchangeRateDisplay" class="text-sm text-gray-500 mt-2"></p>
          <p id="goldPriceDisplay" class="text-sm text-gray-500 mt-1">
            Gold Price: ...
          </p>
        </div>
        <!-- Card #2: Excluded Groups -->
        <div class="flex-1 bg-white p-4 rounded shadow">
          <h4 class="text-lg font-semibold mb-2">Excluded Groups</h4>
          <p class="text-gray-800">
            <span class="font-medium">THB (Excluded):</span>
            <span id="totalExcludedTHB" class="ml-1 font-semibold">0.00</span>
          </p>
          <p class="text-gray-800">
            <span class="font-medium">USD (Excluded):</span>
            <span id="totalExcludedUSD" class="ml-1 font-semibold">0.00</span>
          </p>
          <div class="mt-4">
            <label class="block font-medium mb-1">Exclude Groups:</label>
            <div id="excludeGroupsContainer" class="flex flex-wrap gap-2">
              <!-- checkboxes generated by renderExcludeGroupsUI() -->
            </div>
          </div>
        </div>
      </div>
      <!-- New Row: Profit / Loss Overview and Profit / Loss Excluded Groups -->
      <div class="flex flex-col sm:flex-row gap-4 mt-4">
        <!-- Profit / Loss Overview (All Groups) -->
        <div class="flex-1 bg-white p-4 rounded shadow">
          <h4 class="text-lg font-semibold mb-2">Profit / Loss Overview</h4>
          <p class="text-gray-800">
            <span class="font-medium">Total Cost:</span>
            <span id="totalCost" class="ml-1 font-semibold">0.00</span>
          </p>
          <p class="text-gray-800">
            <span class="font-medium">Profit / Loss:</span>
            <span id="totalProfitLoss" class="ml-1 font-semibold">0.00</span>
          </p>
        </div>
        <!-- Profit / Loss Excluded Groups -->
        <div class="flex-1 bg-white p-4 rounded shadow">
          <h4 class="text-lg font-semibold mb-2">Profit / Loss Excluded Groups</h4>
          <p class="text-gray-800">
            <span class="font-medium">Total Cost:</span>
            <span id="totalCostExcluded" class="ml-1 font-semibold">0.00</span>
          </p>
          <p class="text-gray-800">
            <span class="font-medium">Profit / Loss:</span>
            <span id="totalProfitLossExcluded" class="ml-1 font-semibold">0.00</span>
          </p>
        </div>
      </div>
    </div>

    <!-- Filter Controls สำหรับ Coin Slider -->
    <div id="coinFilterControls" class="flex gap-4 items-center px-4 mt-4">
      <button id="showAllBtn" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 focus:outline-none">Show All</button>
      <button id="showFavBtn" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 focus:outline-none">Show Favorites</button>
    </div>

    <!-- Coin Slider -->
    <div id="coinSlider" class="flex gap-6 overflow-x-auto px-4 snap-x snap-mandatory"></div>

    <!-- Card สำหรับแสดง Latest FNG (Main Card) -->
    <div id="fngCard" class="max-w-sm mx-auto bg-white shadow-lg rounded-lg overflow-hidden mt-4">
      <div class="p-4">
        <h2 class="text-xl font-bold text-center mb-4">CMC Crypto Fear and Greed Index</h2>
        <div class="flex justify-center">
          <div class="relative w-36 h-36">
            <svg class="w-full h-full" viewBox="0 0 100 100">
              <circle class="text-gray-300" stroke-width="8" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50"></circle>
              <circle id="fngProgress" class="text-green-500" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50"
                stroke-dasharray="251.2" stroke-dashoffset="251.2"></circle>
            </svg>
            <div class="absolute inset-0 flex flex-col items-center justify-center">
              <span id="fngValue" class="text-2xl font-bold">--</span>
              <span id="fngClass" class="text-lg">--</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Card สำหรับ Historical Values -->
    <div id="historicalCard" class="max-w-sm mx-auto bg-white shadow-lg rounded-lg overflow-hidden mt-4">
      <div class="p-4">
        <h2 class="text-xl font-bold text-center mb-4">Historical Values</h2>
        <div class="space-y-2">
          <div class="flex justify-between">
            <span class="font-medium">Yesterday</span>
            <span id="historicalYesterday" class="font-medium">--</span>
          </div>
          <div class="flex justify-between">
            <span class="font-medium">Last Week</span>
            <span id="historicalLastWeek" class="font-medium">--</span>
          </div>
          <div class="flex justify-between">
            <span class="font-medium">Last Month</span>
            <span id="historicalLastMonth" class="font-medium">--</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Card สำหรับ Yearly High and Low -->
    <div id="yearlyCard" class="max-w-sm mx-auto bg-white shadow-lg rounded-lg overflow-hidden mt-4">
      <div class="p-4">
        <h2 class="text-xl font-bold text-center mb-4">Yearly High and Low</h2>
        <div class="space-y-2">
          <div class="flex justify-between">
            <span class="font-medium">Yearly High</span>
            <span id="yearlyHigh" class="font-medium">--</span>
          </div>
          <div class="flex justify-between">
            <span class="font-medium">Yearly Low</span>
            <span id="yearlyLow" class="font-medium">--</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Chart Type Selector -->
    <div class="mt-6 mb-2">
      <label for="chartTypeSelect" class="font-medium mr-2">Select Chart Type:</label>
      <select id="chartTypeSelect" class="px-3 py-2 border rounded">
        <option value="line" selected>Line Chart</option>
        <option value="bar">Bar Chart</option>
      </select>
    </div>

    <!-- Chart Section -->
    <div class="mt-6 h-72">
      <h3 class="text-xl font-semibold mb-2">Account Distribution</h3>
      <canvas id="accountsChart" class="bg-white p-4 rounded shadow"></canvas>
    </div>

    <!-- Activity Log -->
    <br>
    <div class="mt-6">
      <h3 class="text-xl font-semibold mb-2">Activity Log</h3>
      <ul id="activityLog" class="list-disc pl-5 text-sm text-gray-700 max-h-48 overflow-y-auto border p-3 rounded bg-white"></ul>
    </div>
  </main>
  <!-- ================== /CONTENT Portfolio ================== -->

  <!-- ================== TRADINGVIEW OVERLAY ================== -->
  <div id="tradingviewOverlay" class="fixed left-0 right-0 bottom-0 top-[4rem] z-40 bg-white hidden">
    <div class="w-full h-full">
      <div id="chart"></div>
      <div class="text-center py-2">
        <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank">
          <span class="blue-text">Track all markets on TradingView</span>
        </a>
      </div>
    </div>
  </div>
  <!-- ================== /TRADINGVIEW OVERLAY ================== -->
   
  <!-- Confirmation Modal สำหรับลบ -->
  <div id="confirmModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
    <div class="bg-white rounded shadow p-6 w-80">
      <h2 class="text-xl font-bold mb-4">Confirm Delete</h2>
      <p class="mb-4">Are you sure you want to delete this account?</p>
      <div class="flex justify-end gap-2">
        <button id="cancelBtn" class="px-3 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
        <button id="confirmBtn" class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600">Delete</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="fixed bottom-4 right-4 flex flex-col gap-2 z-50"></div>

  <!-- Loading Indicator -->
  <div id="loadingOverlay" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 z-50 hidden">
    <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-16 w-16"></div>
  </div>

  <!-- ================== SCRIPT (Portfolio + ฟังก์ชัน) ================== -->
  <script>
    /*************** CONFIG & GLOBAL VARIABLES ***************/
    const devmode = false;
    let accounts = [];
    let editingId = null;
    const mainCurrency = "THB";
    let exchangeRates = {};
    let accountToDelete = null;
    let loggedIn = false;
    let chart;
    let currentChartType = "line";
    let isLoadingData = false;
  
    /*************** GLOBAL VARIABLES FOR FAVORITES ***************/
    let favorites = JSON.parse(localStorage.getItem('favoriteCoins')) || [];
    let coinFilterMode = localStorage.getItem('coinFilterMode') || 'all';
    const filledStarIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.97a1 1 0 00.95.69h4.178c.969 0 1.371 1.24.588 1.81l-3.38 2.455a1 1 0 00-.364 1.118l1.286 3.97c.3.921-.755 1.688-1.54 1.118l-3.38-2.455a1 1 0 00-1.175 0l-3.38 2.455c-.784.57-1.838-.197-1.539-1.118l1.286-3.97a1 1 0 00-.364-1.118L2.049 9.397c-.783-.57-.38-1.81.588-1.81h4.178a1 1 0 00.95-.69l1.286-3.97z"/></svg>`;
    const outlinedStarIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.97a1 1 0 00.95.69h4.178c.969 0 1.371 1.24.588 1.81l-3.38 2.455a1 1 0 00-.364 1.118l1.286 3.97c.3.921-.755 1.688-1.54 1.118l-3.38-2.455a1 1 0 00-1.175 0l-3.38 2.455c-.784.57-1.838-.197-1.539-1.118l1.286-3.97a1 1 0 00-.364-1.118L2.049 9.397c-.783-.57-.38-1.81.588-1.81h4.178a1 1 0 00.95-.69l1.286-3.97z"/></svg>`;
    
    /* >>> (NEW) defaultGroups, defaultSubgroups และ initGroupSubgroupSelects() << */
    const defaultGroups = ["Bank", "Crypto", "Stock", "Game", "Asset"];
    const defaultSubgroups = ["Gaming & Tech Devices", "Collectibles", "Watch"];
    
    function initGroupSubgroupSelects() {
      const groupSelect = document.getElementById('accountGroupSelect');
      const groupManual = document.getElementById('accountGroupManual');
      const subgroupSelect = document.getElementById('accountSubgroupSelect');
      const subgroupManual = document.getElementById('accountSubgroupManual');
    
      groupSelect.innerHTML = `<option value="">(Select Group)</option>`;
      defaultGroups.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g;
        opt.textContent = g;
        groupSelect.appendChild(opt);
      });
      const optOtherG = document.createElement('option');
      optOtherG.value = "__OTHER__";
      optOtherG.textContent = "Other / Manual...";
      groupSelect.appendChild(optOtherG);
    
      subgroupSelect.innerHTML = `<option value="">(Select Sub-group)</option>`;
      defaultSubgroups.forEach(sg => {
        const opt = document.createElement('option');
        opt.value = sg;
        opt.textContent = sg;
        subgroupSelect.appendChild(opt);
      });
      const optOtherS = document.createElement('option');
      optOtherS.value = "__OTHER__";
      optOtherS.textContent = "Other / Manual...";
      subgroupSelect.appendChild(optOtherS);
    
      groupSelect.addEventListener('change', () => {
        if (groupSelect.value === "__OTHER__") {
          groupManual.classList.remove('hidden');
          groupManual.focus();
        } else {
          groupManual.classList.add('hidden');
        }
      });
      subgroupSelect.addEventListener('change', () => {
        if (subgroupSelect.value === "__OTHER__") {
          subgroupManual.classList.remove('hidden');
          subgroupManual.focus();
        } else {
          subgroupManual.classList.add('hidden');
        }
      });
    }
    
    let excludedGroups = JSON.parse(localStorage.getItem('excludedGroups')) || []; 
    let excludedSubgroups = JSON.parse(localStorage.getItem('excludedSubgroups')) || []; 
    
    function toggleFavorite(symbol) {
      if (favorites.includes(symbol)) {
        favorites = favorites.filter(s => s !== symbol);
      } else {
        favorites.push(symbol);
      }
      localStorage.setItem('favoriteCoins', JSON.stringify(favorites));
      loadCoinSlider();
    }
    
    /*************** GOLD ***************/
    async function fetchGoldPrice() {
      try {
        const response = await fetch('/goldprice');
        if (!response.ok) {
          throw new Error('Network error: ' + response.status);
        }
        const data = await response.json();
        const dateObj = new Date(data.lastUpdate);
        const dateFormatted = dateObj.toLocaleString(undefined, {
          year: 'numeric',
          month: 'long',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        let msg = `
          Gold Price (1 oz): 
          ${data.goldPricePerOzUSD.toLocaleString()} USD, 
          ${data.goldPricePerOzTHB.toLocaleString()} THB<br>
    
          Gold Price (1 Baht): 
          ${data.goldPricePerBahtUSD.toLocaleString()} USD, 
          ${data.goldPricePerBahtTHB.toLocaleString()} THB<br>
    
          (Last update: ${dateFormatted} from ${data.source})
        `;
        const goldElem = document.getElementById('goldPriceDisplay');
        goldElem.innerHTML = msg;
      } catch (error) {
        console.error('Error fetching gold price:', error);
        document.getElementById('goldPriceDisplay').textContent = 'Gold Price: Error';
      }
    }
    
    /*************** UTILITY FUNCTIONS ***************/
    function logActivity(message) {
      const logList = document.getElementById('activityLog');
      const li = document.createElement('li');
      const now = new Date().toLocaleTimeString();
      li.textContent = `[${now}] ${message}`;
      logList.prepend(li);
    }
    
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `px-4 py-2 rounded shadow text-white opacity-90 transform transition duration-300 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => {
        toast.classList.add('opacity-0', 'translate-y-2');
        setTimeout(() => { toast.remove(); }, 300);
      }, 3000);
    }
    
    function showLoading(show = true) {
      document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
    }
    
    /*************** EXCHANGE RATE & LOCAL STORAGE ***************/
    async function fetchExchangeRates() {
      try {
        const response = await fetch("https://open.er-api.com/v6/latest/THB");
        const data = await response.json();
        if (data.result === "success") {
          exchangeRates = data.rates;
          let rateUSD = parseFloat(exchangeRates["USD"]);
          if (rateUSD && rateUSD !== 0) {
            document.getElementById('exchangeRateDisplay').textContent =
              `Exchange Rate (USD to THB): 1 USD = ${(1 / rateUSD).toFixed(2)} THB`;
          } else {
            document.getElementById('exchangeRateDisplay').textContent = "";
          }
        } else {
          console.error("Exchange rate API error:", data);
        }
      } catch (error) {
        console.error("Error fetching exchange rates:", error);
      }
    }
    
    async function fetchFNG() {
      try {
        const res = await fetch('/fng');
        if (res.ok) {
          const data = await res.json();
          if (data.latest && data.latest.data) {
            const latest = data.latest.data;
            document.getElementById('fngValue').textContent = latest.value;
            document.getElementById('fngClass').textContent = latest.value_classification;
            const circumference = 2 * Math.PI * 40;
            const offset = circumference * (1 - latest.value / 100);
            document.getElementById('fngProgress').style.strokeDashoffset = offset;
          }
          if (data.historical && data.historical.data && Array.isArray(data.historical.data)) {
            const historical = data.historical.data;
            const latestTimestamp = parseInt(historical[0].timestamp);
            const oneDay = 86400;
            const sevenDays = 7 * oneDay;
            const thirtyDays = 30 * oneDay;
            function findClosest(target) {
              return historical.reduce((prev, curr) => {
                return (Math.abs(parseInt(curr.timestamp) - target) < Math.abs(parseInt(prev.timestamp) - target)) ? curr : prev;
              });
            }
            const yesterdayRecord = findClosest(latestTimestamp - oneDay);
            const lastWeekRecord = findClosest(latestTimestamp - sevenDays);
            const lastMonthRecord = findClosest(latestTimestamp - thirtyDays);
    
            document.getElementById('historicalYesterday').textContent =
              yesterdayRecord.value + " (" + yesterdayRecord.value_classification + ")";
            document.getElementById('historicalLastWeek').textContent =
              lastWeekRecord.value + " (" + lastWeekRecord.value_classification + ")";
            document.getElementById('historicalLastMonth').textContent =
              lastMonthRecord.value + " (" + lastMonthRecord.value_classification + ")";
    
            const yearlyHigh = historical.reduce((max, curr) => (curr.value > max.value ? curr : max), historical[0]);
            const yearlyLow = historical.reduce((min, curr) => (curr.value < min.value ? curr : min), historical[0]);
            function formatDate(timestamp) {
              const date = new Date(parseInt(timestamp) * 1000);
              const options = { month: 'short', day: '2-digit', year: 'numeric' };
              return date.toLocaleDateString(undefined, options);
            }
            document.getElementById('yearlyHigh').textContent =
              yearlyHigh.value + " (" + yearlyHigh.value_classification + ") on " + formatDate(yearlyHigh.timestamp);
            document.getElementById('yearlyLow').textContent =
              yearlyLow.value + " (" + yearlyLow.value_classification + ") on " + formatDate(yearlyLow.timestamp);
          }
        } else {
          console.error("Error fetching FNG data");
        }
      } catch (error) {
        console.error("Error fetching FNG data:", error);
      }
    }
    
    function saveAccountsLocal() {
      localStorage.setItem('accounts', JSON.stringify(accounts));
    }
    
    function loadAccountsLocal() {
      const stored = localStorage.getItem('accounts');
      if (stored) { accounts = JSON.parse(stored); }
    }
    
    /*************** RENDER EXCLUDE CHECKBOX (GROUP + SUBGROUP) ***************/
    function renderExcludeGroupsUI() {
      const groupsData = {};
      accounts.forEach(acc => {
        const grp = acc.group && acc.group.trim() !== "" ? acc.group : "Ungrouped";
        const sub = acc.subgroup && acc.subgroup.trim() !== "" ? acc.subgroup : "";
        if (!groupsData[grp]) {
          groupsData[grp] = new Set();
        }
        if (sub) {
          groupsData[grp].add(sub);
        }
      });
    
      const container = document.getElementById('excludeGroupsContainer');
      container.innerHTML = "";
    
      let allGroups = Object.keys(groupsData);
      let groupNoSubs = [];
      let groupWithSubs = [];
      allGroups.forEach(g => {
        if (groupsData[g].size === 0) {
          groupNoSubs.push(g);
        } else {
          groupWithSubs.push(g);
        }
      });
      let finalOrder = [...groupNoSubs, ...groupWithSubs];
    
      finalOrder.forEach(groupName => {
        const groupWrapper = document.createElement('div');
        groupWrapper.classList.add('mb-2', 'border', 'p-2', 'rounded');
    
        const groupCheckId = `excludeGroup_${groupName}`;
        const groupLabel = document.createElement('label');
        groupLabel.classList.add('flex', 'items-center', 'gap-2');
    
        const groupInput = document.createElement('input');
        groupInput.type = 'checkbox';
        groupInput.id = groupCheckId;
        groupInput.value = groupName;
        groupInput.checked = excludedGroups.includes(groupName);
        groupInput.addEventListener('change', () => {
          if (groupInput.checked) {
            if (!excludedGroups.includes(groupName)) {
              excludedGroups.push(groupName);
            }
          } else {
            excludedGroups = excludedGroups.filter(g => g !== groupName);
          }
          localStorage.setItem('excludedGroups', JSON.stringify(excludedGroups));
          updateTotals();
        });
    
        groupLabel.appendChild(groupInput);
    
        const groupText = document.createElement('span');
        groupText.textContent = groupName;
        groupLabel.appendChild(groupText);
    
        groupWrapper.appendChild(groupLabel);
    
        const subSet = groupsData[groupName];
        subSet.forEach(subName => {
          const combinedKey = `${groupName}::${subName}`;
          const subCheckId = `excludeSub_${combinedKey}`;
    
          const subLabel = document.createElement('label');
          subLabel.classList.add('ml-6', 'flex', 'items-center', 'gap-2');
    
          const subInput = document.createElement('input');
          subInput.type = 'checkbox';
          subInput.id = subCheckId;
          subInput.value = combinedKey;
          subInput.checked = excludedSubgroups.includes(combinedKey);
          subInput.addEventListener('change', () => {
            if (subInput.checked) {
              if (!excludedSubgroups.includes(combinedKey)) {
                excludedSubgroups.push(combinedKey);
              }
            } else {
              excludedSubgroups = excludedSubgroups.filter(x => x !== combinedKey);
            }
            localStorage.setItem('excludedSubgroups', JSON.stringify(excludedSubgroups));
            updateTotals();
          });
    
          subLabel.appendChild(subInput);
    
          const subText = document.createElement('span');
          subText.textContent = `- ${subName}`;
          subLabel.appendChild(subText);
    
          groupWrapper.appendChild(subLabel);
        });
    
        container.appendChild(groupWrapper);
      });
    }
    
    function convertToMain(amount, currency) {
      if (currency === mainCurrency) return parseFloat(amount);
      if (currency === "USD") {
        let rate = parseFloat(exchangeRates["USD"]);
        if (!rate || rate === 0) return 0;
        return parseFloat(amount) / rate;
      }
      return 0;
    }
    
    function updateTotals() {
      // For All Groups
      let totalTHBAll = 0;
      accounts.forEach(acc => {
        totalTHBAll += convertToMain(acc.amount, acc.currency);
      });
      document.getElementById('totalMain').textContent =
        totalTHBAll.toLocaleString(undefined, { style: 'currency', currency: mainCurrency });
    
      let totalUSDAll = 0;
      const rateUSD = parseFloat(exchangeRates["USD"]);
      if (rateUSD && rateUSD !== 0) {
        totalUSDAll = totalTHBAll * rateUSD;
      }
      document.getElementById('totalUSD').textContent =
        totalUSDAll.toLocaleString(undefined, { style: 'currency', currency: 'USD' });
    
      let totalTHBExcluded = 0;
      accounts.forEach(acc => {
        const grp = acc.group && acc.group.trim() !== "" ? acc.group : "Ungrouped";
        const sub = acc.subgroup && acc.subgroup.trim() !== "" ? acc.subgroup : "";
        const combinedKey = `${grp}::${sub}`;
        if (excludedGroups.includes(grp)) return;
        if (sub && excludedSubgroups.includes(combinedKey)) return;
        totalTHBExcluded += convertToMain(acc.amount, acc.currency);
      });
      document.getElementById('totalExcludedTHB').textContent =
        totalTHBExcluded.toLocaleString(undefined, { style: 'currency', currency: mainCurrency });
    
      let totalUSDExcluded = 0;
      if (rateUSD && rateUSD !== 0) {
        totalUSDExcluded = totalTHBExcluded * rateUSD;
      }
      document.getElementById('totalExcludedUSD').textContent =
        totalUSDExcluded.toLocaleString(undefined, { style: 'currency', currency: 'USD' });
    
      // NEW: Profit / Loss Overview (All Groups)
      let totalCostTHB = 0;
      accounts.forEach(acc => {
        const cost = parseFloat(acc.cost) || 0;
        let costInTHB = 0;
        if (acc.currency === mainCurrency) {
          costInTHB = cost;
        } else if (acc.currency === "USD") {
          let rate = parseFloat(exchangeRates["USD"]);
          if (rate && rate !== 0) {
            costInTHB = cost / rate;
          }
        }
        totalCostTHB += costInTHB;
      });
    
      let totalProfitLoss = totalTHBAll - totalCostTHB;
      const totalCostUSD = totalCostTHB * (parseFloat(exchangeRates["USD"]) || 0);
      const totalProfitLossUSD = totalProfitLoss * (parseFloat(exchangeRates["USD"]) || 0);
    
      const totalCostElem = document.getElementById('totalCost');
      totalCostElem.textContent = totalCostTHB.toLocaleString(undefined, { style: 'currency', currency: mainCurrency }) + 
          " (≈ USD " + totalCostUSD.toLocaleString(undefined, { style: 'currency', currency: "USD" }) + ")";
    
      const profitLossElem = document.getElementById('totalProfitLoss');
      profitLossElem.textContent = totalProfitLoss.toLocaleString(undefined, { style: 'currency', currency: mainCurrency }) +
          " (≈ USD " + totalProfitLossUSD.toLocaleString(undefined, { style: 'currency', currency: "USD" }) + ")";
      if(totalProfitLoss >= 0) {
        profitLossElem.classList.remove('text-red-500');
        profitLossElem.classList.add('text-green-500');
      } else {
        profitLossElem.classList.remove('text-green-500');
        profitLossElem.classList.add('text-red-500');
      }
    
      // NEW: Profit / Loss Excluded Groups (คำนวณเฉพาะบัญชีที่ไม่ถูก Exclude)
      let totalCostExcludedTHB = 0;
      let totalAmountExcludedTHB = 0;
      accounts.forEach(acc => {
        const grp = acc.group && acc.group.trim() !== "" ? acc.group : "Ungrouped";
        const sub = acc.subgroup && acc.subgroup.trim() !== "" ? acc.subgroup : "";
        const combinedKey = `${grp}::${sub}`;
        if (excludedGroups.includes(grp)) return;
        if (sub && excludedSubgroups.includes(combinedKey)) return;
        totalAmountExcludedTHB += convertToMain(acc.amount, acc.currency);
        const cost = parseFloat(acc.cost) || 0;
        let costInTHB = 0;
        if (acc.currency === mainCurrency) {
          costInTHB = cost;
        } else if (acc.currency === "USD") {
          let rate = parseFloat(exchangeRates["USD"]);
          if (rate && rate !== 0) {
            costInTHB = cost / rate;
          }
        }
        totalCostExcludedTHB += costInTHB;
      });
      let profitLossExcludedTHB = totalAmountExcludedTHB - totalCostExcludedTHB;
      const totalCostExcludedUSD = totalCostExcludedTHB * (parseFloat(exchangeRates["USD"]) || 0);
      const totalProfitLossExcludedUSD = profitLossExcludedTHB * (parseFloat(exchangeRates["USD"]) || 0);
    
      const totalCostExcludedElem = document.getElementById('totalCostExcluded');
      totalCostExcludedElem.textContent = totalCostExcludedTHB.toLocaleString(undefined, { style: 'currency', currency: mainCurrency }) + 
          " (≈ USD " + totalCostExcludedUSD.toLocaleString(undefined, { style: 'currency', currency: "USD" }) + ")";
    
      const profitLossExcludedElem = document.getElementById('totalProfitLossExcluded');
      profitLossExcludedElem.textContent = profitLossExcludedTHB.toLocaleString(undefined, { style: 'currency', currency: mainCurrency }) +
          " (≈ USD " + totalProfitLossExcludedUSD.toLocaleString(undefined, { style: 'currency', currency: "USD" }) + ")";
      if(profitLossExcludedTHB >= 0) {
        profitLossExcludedElem.classList.remove('text-red-500');
        profitLossExcludedElem.classList.add('text-green-500');
      } else {
        profitLossExcludedElem.classList.remove('text-green-500');
        profitLossExcludedElem.classList.add('text-red-500');
      }
    }
    
    function renderAccounts() {
      let list = accounts.slice();
      const sortType = document.getElementById('sortSelect').value;
      if (sortType === 'name') {
        list.sort((a, b) => a.name.localeCompare(b.name));
      } else if (sortType === 'amount') {
        list.sort((a, b) => parseFloat(b.amount) - parseFloat(a.amount));
      } else if (sortType === 'currency') {
        list.sort((a, b) => a.currency.localeCompare(b.currency));
      }
      
      const groups = {};
      list.forEach(account => {
        const grp = account.group && account.group.trim() !== "" ? account.group : "Ungrouped";
        const subgrp = account.subgroup && account.subgroup.trim() !== "" ? account.subgroup : "";
        if (!groups[grp]) {
          groups[grp] = {};
        }
        if (!groups[grp][subgrp]) {
          groups[grp][subgrp] = [];
        }
        groups[grp][subgrp].push(account);
      });
    
      const tbody = document.getElementById('accountsList');
      let html = "";
    
      for (const groupName in groups) {
        html += `
          <tr class="bg-gray-100 font-bold text-gray-700 text-sm">
            <td colspan="4" class="px-4 py-2 uppercase">
              ${groupName}
            </td>
          </tr>
        `;
        const subgroupsObj = groups[groupName];
        for (const subGroupName in subgroupsObj) {
          if (subGroupName.trim() !== "") {
            html += `
              <tr class="bg-gray-50 italic text-gray-600 text-sm">
                <td colspan="4" class="px-4 py-2 pl-8">
                  - ${subGroupName}
                </td>
              </tr>
            `;
          }
          subgroupsObj[subGroupName].forEach(account => {
            let amountStr = `${parseFloat(account.amount).toLocaleString()} ${account.currency}`;
            if (account.cost !== undefined && account.cost !== null) {
              const costFormatted = parseFloat(account.cost).toLocaleString();
              const profitLoss = parseFloat(account.amount) - parseFloat(account.cost);
              let profitLossFormatted = profitLoss.toLocaleString();
              const profitLossClass = profitLoss >= 0 ? 'text-green-500' : 'text-red-500';
              if (profitLoss > 0) {
                profitLossFormatted = '+' + profitLossFormatted;
              }
              amountStr += ` <span class="text-xs text-gray-400">(${costFormatted} ${account.currency})</span>`;
              amountStr += `<br><span class="text-xs ${profitLossClass}">(${profitLossFormatted} ${account.currency})</span>`;
            }
    
            const convertedText = (account.currency !== mainCurrency)
              ? `<br/><span class="text-sm text-gray-600">
                   ≈ ${convertToMain(account.amount, account.currency)
                      .toLocaleString(undefined, { style: 'currency', currency: mainCurrency })}
                 </span>`
              : "";
    
            html += `
              <tr class="border-b hover:bg-gray-50">
                <td class="px-4 py-2">
                  ${account.name}
                </td>
                <td class="px-4 py-2">
                  ${amountStr}
                  ${convertedText}
                </td>
                <td class="px-4 py-2">${account.currency}</td>
                <td class="px-4 py-2">
                  <button type="button" onclick="editAccount('${account.id}')" 
                    class="px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">Edit</button>
                  <button type="button" onclick="confirmDelete('${account.id}')" 
                    class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 ml-2">Delete</button>
                </td>
              </tr>
            `;
          });
        }
      }
    
      tbody.innerHTML = html;
    
      updateChart();
      renderExcludeGroupsUI();
    }
    
    function getNumericValue(parsed) {
      if (typeof parsed === 'object' && parsed !== null) {
        return parsed.y !== undefined ? parsed.y : parsed.x || 0;
      }
      return typeof parsed === 'number' ? parsed : 0;
    }
    
    function shadeColor(color, percent) {
      let R = parseInt(color.substring(1, 3), 16);
      let G = parseInt(color.substring(3, 5), 16);
      let B = parseInt(color.substring(5, 7), 16);
      R = parseInt((R * (100 + percent)) / 100);
      G = parseInt((G * (100 + percent)) / 100);
      B = parseInt((B * (100 + percent)) / 100);
      R = R < 255 ? R : 255;
      G = G < 255 ? G : 255;
      B = B < 255 ? B : 255;
      const RR = R.toString(16).padStart(2, "0");
      const GG = G.toString(16).padStart(2, "0");
      const BB = B.toString(16).padStart(2, "0");
      return "#" + RR + GG + BB;
    }
    
    function updateChart() {
      const groupTotals = {};
      accounts.forEach((acc) => {
        const grp = acc.group && acc.group.trim() !== "" ? acc.group : "Ungrouped";
        const amtTHB = convertToMain(acc.amount, acc.currency);
        if (!groupTotals[grp]) groupTotals[grp] = 0;
        groupTotals[grp] += amtTHB;
      });
    
      const sortedEntries = Object.entries(groupTotals).sort((a, b) => b[1] - a[1]);
      const labels = sortedEntries.map(([groupName]) => groupName);
      const data = sortedEntries.map(([, total]) => total);
    
      const palette = [
        "#FF6384",
        "#36A2EB",
        "#FFCE56",
        "#4BC0C0",
        "#9966FF",
        "#FF9F40",
        "#66BB6A",
        "#42A5F5"
      ];
    
      let datasetConfig = {
        label: "Distribution (in THB)",
        data: data,
        backgroundColor: palette.slice(0, labels.length),
        borderColor: palette.slice(0, labels.length).map(color => shadeColor(color, -20)),
        borderWidth: 2,
        tension: 0.3,
        pointBackgroundColor: palette.slice(0, labels.length),
        pointBorderColor: "#fff",
        pointRadius: 5,
        fill: true,
        backgroundColor: palette[0] + "33"
      };
    
      const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: 20 },
        plugins: {
          legend: {
            display: true,
            position: "top",
            labels: { font: { size: 14, family: "Arial, sans-serif" } }
          },
          tooltip: {
            callbacks: {
              label: function (context) {
                const rawValue = getNumericValue(context.parsed);
                const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                const percent = ((rawValue / total) * 100).toFixed(2) + "%";
                return `${context.label}: ${rawValue.toLocaleString()} THB (${percent})`;
              }
            }
          },
          datalabels: {
            display: context => {
              const value = context.dataset.data[context.dataIndex] || 0;
              return value > 0;
            },
            formatter: (value, context) => {
              const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
              const percent = (value / total) * 100;
              return percent.toFixed(2) + "%";
            },
            color: "#fff",
            backgroundColor: "rgba(0, 0, 0, 0.7)",
            borderRadius: 4,
            padding: 4,
            anchor: "center",
            align: "center",
            offset: 10
          }
        },
        scales: {
          x: { grid: { display: false }, ticks: { font: { size: 12 } } },
          y: { grid: { color: "#f0f0f0" }, ticks: { beginAtZero: true, font: { size: 12 } } }
        }
      };
    
      if (chart) {
        chart.config.type = currentChartType;
        chart.data.labels = labels;
        chart.data.datasets[0] = datasetConfig;
        chart.options = commonOptions;
        chart.update();
      } else {
        const ctx = document.getElementById("accountsChart").getContext("2d");
        chart = new Chart(ctx, {
          type: currentChartType,
          data: { labels: labels, datasets: [datasetConfig] },
          plugins: [ChartDataLabels],
          options: commonOptions
        });
      }
    }
    
    function setupChartTypeSelector() {
      const chartTypeSelect = document.getElementById('chartTypeSelect');
      if (chartTypeSelect) {
        chartTypeSelect.addEventListener('change', (e) => {
          currentChartType = e.target.value;
          updateChart();
        });
      }
    }
    
    async function autoSaveDataToServer() {
      if (!devmode && !loggedIn) return;
      showLoading(true);
      try {
        const res = await fetch('/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accounts })
        });
        if (res.ok) {
          logActivity('Data saved to server');
          showToast('Data auto-saved to server!', 'success');
        } else {
          showToast('Error auto-saving data.', 'error');
        }
      } catch (error) {
        console.error('Auto-save error:', error);
        showToast('Error auto-saving data.', 'error');
      }
      showLoading(false);
    }
    
    async function autoLoadDataFromServer() {
      if (!devmode && !loggedIn) return;
      if (isLoadingData) return;
      isLoadingData = true;
      showLoading(true);
      let success = false;
      while (!success) {
        try {
          const res = await fetch('/load');
          if (!res.ok) {
            throw new Error("Server load failed with status " + res.status);
          }
          const data = await res.json();
          accounts = data.accounts || [];
          saveAccountsLocal();
          await fetchExchangeRates();
          renderAccounts();
          updateTotals();
          logActivity('Data auto-loaded from server');
          showToast('Data loaded successfully from server!', 'success');
          success = true;
        } catch (error) {
          console.error('Auto-load error, retrying in 2 seconds:', error);
          showToast('Error loading data, retrying...', 'error');
          await new Promise(resolve => setTimeout(resolve, 2000));
        }
      }
      showLoading(false);
      isLoadingData = false;
    }
    
    async function loadCoinSlider() {
      try {
        const res = await fetch('/cmc/listings');
        if (!res.ok) {
          throw new Error('Failed to fetch coin listings');
        }
        const data = await res.json();
        let coins = data.data;
        if (coinFilterMode === 'favorites') {
          coins = coins.filter(coin => favorites.includes(coin.symbol));
        }
        let html = "";
        coins.forEach(coin => {
          const price = coin.quote.USD.price;
          const percentChange = coin.quote.USD.percent_change_24h;
          const arrowSvgDown = `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="inline-block" style="height: 16px; width: 16px;" viewBox="0 0 24 24"><path d="M18.0566 8H5.94336C5.10459 8 4.68455 9.02183 5.27763 9.61943L11.3343 15.7222C11.7019 16.0926 12.2981 16.0926 12.6657 15.7222L18.7223 9.61943C19.3155 9.02183 18.8954 8 18.0566 8Z"></path></svg>`;
          const arrowSvgUp = `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="inline-block" style="height: 16px; width: 16px;" viewBox="0 0 24 24"><path d="M5.94336 16H18.0566C18.8954 16 19.3155 14.9782 18.7223 14.3806L12.6657 8.27783C12.2981 7.90739 11.7019 7.90739 11.3343 8.27783L5.27763 14.3806C4.68455 14.9782 5.10459 16 5.94336 16Z"></path></svg>`;
          const changeIcon = percentChange < 0 ? arrowSvgDown : arrowSvgUp;
          const changeColor = percentChange < 0 ? 'red' : 'green';
          const priceFormatted = `$${price.toFixed(2)}`;
          const percentFormatted = `${Math.abs(percentChange).toFixed(2)}%`;
    
          const isFav = favorites.includes(coin.symbol);
          const starIcon = isFav ? filledStarIcon : outlinedStarIcon;
          
          html += `
          <div class="w-48 bg-white rounded-xl shadow-lg p-4 relative flex-shrink-0 transform transition duration-300 hover:scale-105 snap-start">
            <button class="absolute top-2 right-2 focus:outline-none" onclick="toggleFavorite('${coin.symbol}')">
              ${starIcon}
            </button>
            <div class="block">
              <img class="w-16 h-16 mx-auto mb-2 rounded-full border border-gray-200" src="https://s2.coinmarketcap.com/static/img/coins/64x64/${coin.id}.png" alt="${coin.name} Logo" loading="lazy">
              <div class="text-center">
                <span class="block font-bold text-lg text-gray-800">${coin.name}</span>
                <span class="block text-sm text-gray-500">${coin.symbol}</span>
                <span class="block text-sm text-gray-500">${priceFormatted}</span>
                <span class="block text-sm font-medium" style="color: ${changeColor};">
                  ${changeIcon} ${percentFormatted}
                </span>
              </div>
              <img class="w-full mt-3" src="https://s3.coinmarketcap.com/generated/sparklines/web/1d/2781/${coin.id}.svg" alt="${coin.name} Price Graph">
            </div>
          </div>
          `;
        });
        document.getElementById('coinSlider').innerHTML = html;
      } catch (error) {
        console.error("Error loading coin slider:", error);
      }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      setupChartTypeSelector();
      if (!devmode) {
        const adminLoginFields = document.getElementById('adminLoginFields');
        if (adminLoginFields) { adminLoginFields.classList.add('hidden'); }
      }
      document.getElementById('showAllBtn').addEventListener('click', () => {
        coinFilterMode = 'all';
        localStorage.setItem('coinFilterMode', coinFilterMode);
        loadCoinSlider();
      });
      document.getElementById('showFavBtn').addEventListener('click', () => {
        coinFilterMode = 'favorites';
        localStorage.setItem('coinFilterMode', coinFilterMode);
        loadCoinSlider();
      });
      
      // (NEW) เรียก initGroupSubgroupSelects() เมื่อ DOM Ready
      initGroupSubgroupSelects();
    
      // (แก้ส่วน submit) ใช้ค่าจาก select/manual สำหรับ Group/Subgroup และอ่านค่า cost
      document.getElementById('accountForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const groupSelect = document.getElementById('accountGroupSelect');
        const groupManual = document.getElementById('accountGroupManual');
        const subgroupSelect = document.getElementById('accountSubgroupSelect');
        const subgroupManual = document.getElementById('accountSubgroupManual');
        let finalGroup;
        if (groupSelect.value === "__OTHER__") {
          finalGroup = groupManual.value.trim() || "Ungrouped";
        } else {
          finalGroup = groupSelect.value.trim() || "Ungrouped";
        }
        let finalSubgroup;
        if (subgroupSelect.value === "__OTHER__") {
          finalSubgroup = subgroupManual.value.trim() || "";
        } else {
          finalSubgroup = subgroupSelect.value.trim() || "";
        }
        const costVal = document.getElementById('accountCost').value;
        const account = {
          id: editingId || Date.now().toString(),
          name: document.getElementById('accountName').value,
          amount: document.getElementById('accountAmount').value,
          cost: costVal, // เพิ่ม field ต้นทุน
          currency: document.getElementById('accountCurrency').value,
          group: finalGroup,
          subgroup: finalSubgroup,
        };
        if (editingId) {
          const idx = accounts.findIndex(a => a.id === editingId);
          accounts[idx] = account;
          logActivity(`Updated account: ${account.name}`);
          showToast('Account updated successfully!', 'success');
          editingId = null;
        } else {
          accounts.push(account);
          logActivity(`Added new account: ${account.name}`);
          showToast('Account added successfully!', 'success');
        }
        document.getElementById('accountForm').reset();
        groupSelect.value = "";
        groupManual.value = "";
        groupManual.classList.add('hidden');
        subgroupSelect.value = "";
        subgroupManual.value = "";
        subgroupManual.classList.add('hidden');
        saveAccountsLocal();
        renderAccounts();
        updateTotals();
        await autoSaveDataToServer();
      });
    });
    
    function editAccount(id) {
      const acc = accounts.find(a => a.id === id);
      document.getElementById('accountName').value = acc.name;
      document.getElementById('accountAmount').value = acc.amount;
      document.getElementById('accountCost').value = acc.cost || "";
      document.getElementById('accountCurrency').value = acc.currency;
      const groupSelect = document.getElementById('accountGroupSelect');
      const groupManual = document.getElementById('accountGroupManual');
      if (acc.group && defaultGroups.includes(acc.group)) {
        groupSelect.value = acc.group;
        groupManual.classList.add('hidden');
        groupManual.value = "";
      } else if (acc.group && acc.group !== "Ungrouped") {
        groupSelect.value = "__OTHER__";
        groupManual.value = acc.group;
        groupManual.classList.remove('hidden');
      } else {
        groupSelect.value = "";
        groupManual.value = "";
        groupManual.classList.add('hidden');
      }
      const subgroupSelect = document.getElementById('accountSubgroupSelect');
      const subgroupManual = document.getElementById('accountSubgroupManual');
      if (acc.subgroup && defaultSubgroups.includes(acc.subgroup)) {
        subgroupSelect.value = acc.subgroup;
        subgroupManual.classList.add('hidden');
        subgroupManual.value = "";
      } else if (acc.subgroup && acc.subgroup !== "") {
        subgroupSelect.value = "__OTHER__";
        subgroupManual.value = acc.subgroup;
        subgroupManual.classList.remove('hidden');
      } else {
        subgroupSelect.value = "";
        subgroupManual.value = "";
        subgroupManual.classList.add('hidden');
      }
      editingId = id;
    }
    
    function confirmDelete(id) {
      accountToDelete = id;
      document.getElementById('confirmModal').classList.remove('hidden');
    }
    document.getElementById('cancelBtn').addEventListener('click', () => {
      accountToDelete = null;
      document.getElementById('confirmModal').classList.add('hidden');
    });
    document.getElementById('confirmBtn').addEventListener('click', async () => {
      if (accountToDelete) {
        accounts = accounts.filter(a => a.id !== accountToDelete);
        logActivity(`Deleted account with ID: ${accountToDelete}`);
        showToast('Account deleted successfully!', 'success');
        accountToDelete = null;
        saveAccountsLocal();
        renderAccounts();
        updateTotals();
        await autoSaveDataToServer();
      }
      document.getElementById('confirmModal').classList.add('hidden');
    });
    
    document.getElementById('saveBtn').addEventListener('click', async () => {
      showLoading(true);
      try {
        const res = await fetch('/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accounts })
        });
        if (res.ok) {
          logActivity('Data saved to server (manual)');
          showToast('Data saved successfully to file!', 'success');
        } else {
          showToast('Error saving data.', 'error');
        }
      } catch (error) {
        console.error('Save error:', error);
        showToast('Error saving data.', 'error');
      }
      showLoading(false);
    });
    
    document.getElementById('loadBtn').addEventListener('click', async () => {
      await autoLoadDataFromServer();
    });
    
    document.getElementById('exportBtn').addEventListener('click', () => {
      let csvContent = "data:text/csv;charset=utf-8,Name,Amount,Currency,Group\n";
      accounts.forEach(acc => {
        csvContent += `${acc.name},${acc.amount},${acc.currency},${acc.group || ""}\n`;
      });
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "accounts.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      logActivity('Exported data as CSV');
      showToast('Data exported as CSV!', 'success');
    });
    
    document.getElementById('importInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        const text = event.target.result;
        const lines = text.split('\n').slice(1);
        lines.forEach(line => {
          if (line.trim()) {
            const parts = line.split(',');
            const [name, amount, currency, group] = parts;
            const newAcc = {
              id: Date.now().toString() + Math.random().toString().slice(2),
              name: (name || '').trim(),
              amount: (amount || '').trim(),
              currency: (currency || '').trim(),
              group: (group || '').trim() || "Ungrouped"
            };
            if(newAcc.name) { 
              accounts.push(newAcc);
              logActivity(`Imported account: ${newAcc.name}`);
            }
          }
        });
        saveAccountsLocal();
        renderAccounts();
        updateTotals();
        showToast('Data imported successfully!', 'success');
      };
      reader.readAsText(file);
    });
    const sortSelect = document.getElementById('sortSelect');
    sortSelect.value = localStorage.getItem('sortType') || 'amount';
    localStorage.setItem('sortType', sortSelect.value);
    
    document.getElementById('sortSelect').addEventListener('change', () => {
      const sortSelect = document.getElementById('sortSelect');
      localStorage.setItem('sortType', sortSelect.value);
      renderAccounts();
    });
    
    if (devmode) {
      document.getElementById('loginForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const user = document.getElementById('username').value;
        const pass = document.getElementById('password').value;
        if (user === 'admin' && pass === 'admin') {
          loggedIn = true;
          document.getElementById('loginModal').classList.add('hidden');
          document.getElementById('appContainer').classList.remove('hidden');
          logActivity('User logged in via admin form (dev mode)');
          showToast('Login successful!', 'success');
          fetchExchangeRates().then(() => {
            renderAccounts();
            updateTotals();
          });
        } else {
          showToast('Invalid credentials.', 'error');
        }
      });
    }
    
    async function checkLoginStatus() {
      try {
        const res = await fetch('/user');
        const data = await res.json();
        if (data.loggedIn) {
          loggedIn = true;
          document.getElementById('loginModal').classList.add('hidden');
          document.getElementById('appContainer').classList.remove('hidden');
          logActivity('User logged in via Google');
        }
      } catch (error) {
        console.error('Error checking login status:', error);
      }
    }
    
    const btnPortfolio = document.getElementById('btnPortfolio');
    const btnTradingView = document.getElementById('btnTradingView');
    const appContainer = document.getElementById('appContainer');
    const tradingviewOverlay = document.getElementById('tradingviewOverlay');
    
    btnPortfolio.addEventListener('click', () => {
      tradingviewOverlay.classList.add('hidden');
      appContainer.classList.remove('hidden');
    });
    btnTradingView.addEventListener('click', () => {
      appContainer.classList.add('hidden');
      tradingviewOverlay.classList.remove('hidden');
    });
    
    window.addEventListener('load', async () => {
      await checkLoginStatus();
      await fetchExchangeRates();
      await fetchFNG();
      loadAccountsLocal();
      renderAccounts();
      updateTotals();
      loadCoinSlider();
      await fetchGoldPrice(); 
    });
    
    document.addEventListener('visibilitychange', async () => {
      if (!document.hidden) {
        await autoLoadDataFromServer();
      }
    });
    window.addEventListener('focus', async () => {
      await autoLoadDataFromServer();
    });
  </script>
  <script>
    // (1) จำค่า symbol/interval ใน localStorage
    const savedSymbol   = localStorage.getItem('tvSymbol')   || "BINANCE:BTCUSDT";
    const savedInterval = localStorage.getItem('tvInterval') || "240";
    
    // (2) สร้าง widget ตอนโหลดหน้า
    window.addEventListener('load', function() {
      const tvWidget = new TradingView.widget({
        "autosize": true,
        "symbol": savedSymbol,
        "interval": savedInterval,
        "theme": "dark",
        "style": "1",
        "locale": "en",
        "toolbar_bg": "#f1f3f6",
        "hide_side_toolbar": true,
        "allow_symbol_change": true,
        "watchlist": [
          "BINANCE:SOLUSDT",
          "BINANCE:DOGEUSDT",
          "BINANCE:PEPEUSDT",
          "BINANCE:TRUMPUSDT",
          "BINANCE:BTCUSDT",
          "BINANCE:ETHUSDT",
          "NASDAQ:NVDA",
          "NYSE:TSM"
        ],
        "details": true,
        "hotlist": true,
        "calendar": true,
        "studies": ["STD;SMA"],
        "container_id": "chart",
        "show_popup_button": true,
        "popup_width": "1000",
        "popup_height": "650"
      });
    
      if (typeof tvWidget.onChartReady === "function") {
        tvWidget.onChartReady(() => {
          tvWidget.chart().onSymbolChanged().subscribe(null, (symbolData) => {
            localStorage.setItem('tvSymbol', symbolData.name);
          });
          tvWidget.chart().onIntervalChanged().subscribe(null, (newInterval) => {
            localStorage.setItem('tvInterval', newInterval);
          });
        });
      }
    });
  </script>
</body>
</html>
